- name: populate package facts
  package_facts:

# R-230226 RHEL-08-010050
- name: stigrule_230226__etc_dconf_db_local_d_01_banner_message
  ini_file:
    path: /etc/dconf/db/local.d/01-banner-message
    section: org/gnome/login-screen
    option: banner-message-text
    value: "{{ rhel8STIG_stigrule_230226__etc_dconf_db_local_d_01_banner_message_Value }}"
    no_extra_spaces: yes
  notify: dconf_update
  when:
    - rhel8STIG_stigrule_230226_Manage
    - "'dconf' in packages"

# R-230229 RHEL-08-010090
- name: stigrule_230229_install_dod_root_ca
  ansible.builtin.copy:
    src: /path/to/your/DoD_root_CA.pem # Replace with the actual path to your DoD root CA file
    dest: /etc/sssd/pki/sssd_auth_ca_db.pem
    mode: '0644'
    owner: root
    group: root
  when: rhel8STIG_stigrule_230229_Manage
  notify:
    - sssd_restart

# R-230233 RHEL-08-010130
- name: stigrule_230233_set_sha_crypt_min_rounds
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^SHA_CRYPT_MIN_ROUNDS\s+'
    line: 'SHA_CRYPT_MIN_ROUNDS 100000'
    state: present
    backup: yes
  become: yes
  when:
    - rhel8STIG_stigrule_230233_Manage
  notify:
    - ssh_restart

- name: stigrule_230233_set_sha_crypt_max_rounds
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^SHA_CRYPT_MAX_ROUNDS\s+'
    line: 'SHA_CRYPT_MAX_ROUNDS 100000'
    state: present
    backup: yes
  become: yes
  when:
    - rhel8STIG_stigrule_230233_Manage
  notify:
    - ssh_restart

# R-230251 RHEL-08-010290
- name: stigrule_230251_configure_ssh_server_macs
  ansible.builtin.lineinfile:
    path: "{{ lookup('pipe', 'readlink -f /etc/crypto-policies/back-ends/opensshserver.config') }}"
    regexp: '^(-oMACs=).*' # Match the line starting with -oMACs=
    line: '{{ rhel8STIG_stigrule_230251_opensshserver_config_MACs_Line }}' # The exact desired line content
    backup: yes
  when: rhel8STIG_stigrule_230251_Manage
  notify:
    - do_reboot

# R-230252 RHEL-08-010291
- name: stigrule_230252_configure_ssh_server_ciphers
  ansible.builtin.lineinfile:
    path: "{{ lookup('pipe', 'readlink -f /etc/crypto-policies/back-ends/opensshserver.config') }}"
    regexp: '^(-oCiphers=).*' # Match the line starting with -oCiphers=
    line: '{{ rhel8STIG_stigrule_230252_opensshserver_config_Ciphers_Line }}' # The exact desired line content
    backup: yes
  when: rhel8STIG_stigrule_230252_Manage
  notify:
    - do_reboot

# R-230256 RHEL-08-010295
- name: stigrule_230256__etc_crypto_policies_back_ends_gnutls_config
  lineinfile:
    path: /etc/crypto-policies/back-ends/gnutls.config
    regexp: '^\+VERS'
    line: "{{ rhel8STIG_stigrule_230256__etc_crypto_policies_back_ends_gnutls_config_Line }}"
    create: yes
  when:
    - rhel8STIG_stigrule_230256_Manage

# R-230274 RHEL-08-010400
- name: stigrule_230274_sssd_certificate_verification
  ini_file:
    path: /etc/sssd/sssd.conf
    section: sssd
    option: certificate_verification
    value: "{{ rhel8STIG_stigrule_230274_sssd_cert_verification_Line | replace('certificate_verification = ', '') }}"
    no_extra_spaces: yes
  when: rhel8STIG_stigrule_230274_Manage
  notify:
    - sssd_restart

# R-230277 RHEL-08-010421
- name: stigrule_230277_enable_page_poisoning_grubby
  ansible.builtin.command: "grubby --update-kernel=ALL --args=\"page_poison={{ rhel8STIG_stigrule_230277_grub_cmdline_page_poison_Value }}\""
  when: rhel8STIG_stigrule_230277_Manage
  notify: do_reboot

- name: stigrule_230277_enable_page_poisoning_default_grub
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX=.*)"$'
    line: '\1 page_poison={{ rhel8STIG_stigrule_230277_grub_cmdline_page_poison_Value }}"'
    backrefs: yes
    state: present
  when: rhel8STIG_stigrule_230277_Manage
  notify: do_reboot

# R-230278 RHEL-08-010422
- name: stigrule_230278_disable_vsyscalls_grubby
  ansible.builtin.command: "grubby --update-kernel=ALL --args=\"vsyscall={{ rhel8STIG_stigrule_230278_grub_cmdline_vsyscall_Value }}\""
  when: rhel8STIG_stigrule_230278_Manage
  notify: do_reboot

- name: stigrule_230278_disable_vsyscalls_default_grub
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX=.*)"$'
    line: '\1 vsyscall={{ rhel8STIG_stigrule_230278_grub_cmdline_vsyscall_Value }}"'
    backrefs: yes
    state: present
  when: rhel8STIG_stigrule_230278_Manage
  notify: do_reboot

# R-230279 RHEL-08-010423
- name: stigrule_230279_enable_init_on_free_grubby
  ansible.builtin.command: "grubby --update-kernel=ALL --args=\"init_on_free={{ rhel8STIG_stigrule_230279_grub_cmdline_init_on_free_Value }}\""
  when: rhel8STIG_stigrule_230279_Manage
  notify: do_reboot

- name: stigrule_230279_enable_init_on_free_default_grub
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX=.*)"$'
    line: '\1 init_on_free={{ rhel8STIG_stigrule_230279_grub_cmdline_init_on_free_Value }}"'
    backrefs: yes
    state: present
  when: rhel8STIG_stigrule_230279_Manage
  notify: do_reboot

# R-230299 RHEL-08-010570
- name: stigrule_230299_mount_home_nosuid
  ansible.posix.mount:
    path: "{{ item.mount }}"
    src: "{{ item.device }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.options }},{{ rhel8STIG_stigrule_230299_home_nosuid_MountOption }}"
    state: mounted
  loop: "{{ ansible_mounts | selectattr('mount', 'match', '^/home') | list }}"
  when: rhel8STIG_stigrule_230299_Manage and (item.options.find(rhel8STIG_stigrule_230299_home_nosuid_MountOption) == -1)

# R-230302 RHEL-08-010590
- name: stigrule_230302_mount_home_noexec
  ansible.posix.mount:
    path: "{{ item.mount }}"
    src: "{{ item.device }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.options }},{{ rhel8STIG_stigrule_230302_home_noexec_MountOption }}"
    state: mounted
  loop: "{{ ansible_mounts | selectattr('mount', 'match', '^/home') | list }}"
  when: rhel8STIG_stigrule_230302_Manage and (item.options.find(rhel8STIG_stigrule_230302_home_noexec_MountOption) == -1)

# R-230311 RHEL-08-010671
- name: stigrule_230311__etc_sysctl_d_99_sysctl_conf
  lineinfile:
    path: /etc/sysctl.d/99-sysctl.conf
    regexp: 'kernel.core_pattern='
    line: "{{ rhel8STIG_stigrule_230311__etc_sysctl_d_99_sysctl_conf_Line }}"
    create: yes
  when:
    - rhel8STIG_stigrule_230311_Manage

- name: stigrule_230311_kernel_core_pattern
  sysctl:
    name: kernel.core_pattern
    value: "{{ rhel8STIG_stigrule_230311_kernel_core_pattern_Value }}"
  when:
    - rhel8STIG_stigrule_230311_Manage

# R-230312 RHEL-08-010672
- name: stigrule_230312_mask_systemd_coredump_socket
  ansible.builtin.systemd:
    name: systemd-coredump.socket
    masked: "{{ rhel8STIG_stigrule_230312_systemd_coredump_socket_Masked }}"
    state: stopped
  when: rhel8STIG_stigrule_230312_Manage
  notify: daemon_reload

# R-230316 RHEL-08-010680
- name: stigrule_230316_configure_nameservers
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    line: "nameserver {{ rhel8STIG_stigrule_230316_nameserver_1 }}"
    create: yes
    state: present
  when: rhel8STIG_stigrule_230316_Manage

- name: stigrule_230316_configure_nameservers_2
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    line: "nameserver {{ rhel8STIG_stigrule_230316_nameserver_2 }}"
    create: yes
    state: present
  when: rhel8STIG_stigrule_230316_Manage
  
# R-230321 RHEL-08-010730
# First, gather the passwd entries using getent
- name: stigrule_230321_get_passwd_entries
  ansible.builtin.getent:
    database: passwd
  register: passwd_entries
  when: rhel8STIG_stigrule_230321_Manage

- name: stigrule_230321_set_home_directory_mode
  ansible.builtin.file:
    path: "{{ user_entry.value[5] }}" # The 6th field (index 5) in /etc/passwd is the home directory
    mode: "{{ rhel8STIG_stigrule_230321_home_dir_mode }}"
  loop: "{{ passwd_entries.ansible_facts.getent_passwd | dict2items }}" # Convert the dictionary to a list of items for looping
  loop_control:
    loop_var: user_entry # Use a clear variable name for each item in the loop
  when:
    - rhel8STIG_stigrule_230321_Manage
    # Filter for UID >= 1000 (3rd field, index 2)
    - user_entry.value[2] is defined and user_entry.value[2] | int >= 1000
    # Ensure home directory is defined and not empty (6th field, index 5)
    - user_entry.value[5] is defined and user_entry.value[5] | length > 0
    # Exclude the root user's home directory if it's just '/', or other system homes like '/run/user/1000'
    # This is an important security nuance: often we don't change permissions for "/" or non-persistent user run directories.
    # Adjust this filter based on your specific STIG interpretation for system accounts vs. regular users.
    - not (user_entry.value[5] == '/' or user_entry.value[5].startswith('/run/user'))

# R-230333 RHEL-08-020011
- name: stigrule_230333_configure_faillock_deny
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^deny\s*='
    line: "deny = {{ rhel8STIG_stigrule_230333_faillock_deny_Value }}"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230333_Manage

# R-230335 RHEL-08-020013
- name: stigrule_230335_configure_faillock_fail_interval
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^fail_interval\s*='
    line: "fail_interval = {{ rhel8STIG_stigrule_230335_faillock_fail_interval_Value }}"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230335_Manage

# R-230337 RHEL-08-020015
- name: stigrule_230337_configure_faillock_unlock_time
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^unlock_time\s*='
    line: "unlock_time = {{ rhel8STIG_stigrule_230337_faillock_unlock_time_Value }}"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230337_Manage

# R-230339 RHEL-08-020017
- name: stigrule_230339_configure_faillock_dir
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^dir\s*='
    line: "dir = {{ rhel8STIG_stigrule_230339_faillock_dir_Value }}"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230339_Manage

# R-230341 RHEL-08-020019
- name: stigrule_230341_configure_faillock_silent
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^silent'
    line: "silent"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230341_Manage and rhel8STIG_stigrule_230341_faillock_silent_Enabled

# R-230343 RHEL-08-020021
- name: stigrule_230343_configure_faillock_audit
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^audit'
    line: "audit"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230343_Manage and rhel8STIG_stigrule_230343_faillock_audit_Enabled

# R-230345 RHEL-08-020023
- name: stigrule_230345_configure_faillock_even_deny_root
  ansible.builtin.lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^even_deny_root'
    line: "even_deny_root"
    state: present
    create: yes
  when: rhel8STIG_stigrule_230345_Manage and rhel8STIG_stigrule_230345_faillock_even_deny_root_Enabled

# R-230351 RHEL-08-020050
- name: stigrule_230351_configure_smartcard_removal_action
  ini_file:
    path: /etc/dconf/db/local.d/20-authselect
    section: org/gnome/settings-daemon/peripherals/smartcard
    option: removal-action
    value: "{{ rhel8STIG_stigrule_230351_smartcard_removal_action_Value }}"
    no_extra_spaces: yes
  when:
    - rhel8STIG_stigrule_230351_Manage
    - "'dconf' in packages"
  notify: dconf_update

# R-230364 RHEL-08-020180
- name: Get list of regular users via getent
  ansible.builtin.shell: |
    getent passwd | awk -F: '$3 >= 1000 && $3 < 60000 {print $1}'
  # This `awk` filters for UIDs 1000 and above, but below 60000 (standard for regular users on many Linux systems).
  # Adjust 60000 if your user UID range is different.
  register: regular_users
  changed_when: false # This command just queries, doesn't change state
  when: rhel8STIG_stigrule_230364_Manage

- name: stigrule_230364_set_min_password_age
  ansible.builtin.command: "chage -m {{ rhel8STIG_stigrule_230364_min_password_age_Value }} {{ item }}"
  loop: "{{ regular_users.stdout_lines }}" # Use the list from our shell command
  when: rhel8STIG_stigrule_230364_Manage

# R-230372 RHEL-08-020250
- name: stigrule_230372_set_sssd_pam_cert_auth
  ini_file:
    path: /etc/sssd/sssd.conf
    section: pam
    option: pam_cert_auth
    value: "{{ rhel8STIG_stigrule_230372_sssd_pam_cert_auth_Value }}"
    no_extra_spaces: yes
  when: rhel8STIG_stigrule_230372_Manage
  notify: sssd_restart

- name: stigrule_230372_configure_pam_d_smartcard_auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/smartcard-auth
    regexp: '^\s*auth\s+sufficient\s+pam_sss.so'
    line: "auth sufficient pam_sss.so {{ rhel8STIG_stigrule_230372_pam_sss_cert_auth_Option }}"
    state: present
  when: rhel8STIG_stigrule_230372_Manage

- name: stigrule_230372_configure_pam_d_system_auth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^\s*auth\s+\[success=done authinfo_unavail=ignore ignore=ignore default=die\]\s+pam_sss.so'
    line: "auth [success=done authinfo_unavail=ignore ignore=ignore default=die] pam_sss.so {{ rhel8STIG_stigrule_230372_pam_sss_cert_auth_Option }}"
    state: present
  when: rhel8STIG_stigrule_230372_Manage

# R-230373 RHEL-08-020260
- name: stigrule_230373_set_useradd_inactive
  ansible.builtin.command: "useradd -D -f {{ rhel8STIG_stigrule_230373_useradd_inactive_Value }}"
  when: rhel8STIG_stigrule_230373_Manage

# R-230466 RHEL-08-030590
- name: stigrule_230466__etc_audit_rules_d_audit_rules__var_log_faillock
  lineinfile:
    path: /etc/audit/rules.d/audit.rules
    regexp: '^-w /var/log/faillock -p wa -k logins$'
    line: "{{ rhel8STIG_stigrule_230466__etc_audit_rules_d_audit_rules__var_log_faillock_Line }}"
  notify: auditd_restart
  when: rhel8STIG_stigrule_230466_Manage

# R-230475 RHEL-08-030650
- name: stigrule_230475_install_aide
  ansible.builtin.yum:
    name: aide
    state: installed
  when: rhel8STIG_stigrule_230475_Manage

- name: stigrule_230475_configure_aide_audit_tools
  ansible.builtin.lineinfile:
    path: /etc/aide.conf
    line: "{{ item }}"
    state: present
  loop: "{{ rhel8STIG_stigrule_230475_aide_config_audit_tools }}"
  when: rhel8STIG_stigrule_230475_Manage

- name: stigrule_230475_initialize_aide
  ansible.builtin.command: "/usr/sbin/aide --init"
  args:
    creates: /var/lib/aide/aide.db.new.gz
  when: rhel8STIG_stigrule_230475_Manage

- name: stigrule_230475_rename_aide_database
  ansible.builtin.command: "mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz"
  args:
    removes: /var/lib/aide/aide.db.new.gz
    creates: /var/lib/aide/aide.db.gz
  when: rhel8STIG_stigrule_230475_Manage

# R-230479 RHEL-08-030690
- name: stigrule_230479_configure_rsyslog_remote_logging
  ansible.builtin.lineinfile:
    path: /etc/rsyslog.conf
    line: "{{ rhel8STIG_stigrule_230479_rsyslog_remote_protocol }}{{ rhel8STIG_stigrule_230479_rsyslog_remote_server }}:{{ rhel8STIG_stigrule_230479_rsyslog_remote_port }}"
    insertafter: EOF
    state: present
  when: rhel8STIG_stigrule_230479_Manage
  notify: rsyslog_restart

# R-230484 RHEL-08-030740
- name: stigrule_230484_configure_chrony_ntp_server
  ansible.builtin.lineinfile:
    path: /etc/chrony.conf
    regexp: '^server\s+'
    line: "server {{ rhel8STIG_stigrule_230484_chrony_ntp_server }} iburst maxpoll {{ rhel8STIG_stigrule_230484_chrony_maxpoll_Value }}"
    state: present
  when: rhel8STIG_stigrule_230484_Manage
  notify: chronyd_restart

# R-230503 RHEL-08-040080
- name: stigrule_230503_blacklist_usb_storage
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/blacklist.conf
    line: "install usb-storage /bin/false"
    create: yes
    state: present
  when: rhel8STIG_stigrule_230503_Manage and rhel8STIG_stigrule_230503_usb_storage_blacklist

- name: stigrule_230503_blacklist_usb_storage_module
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/blacklist.conf
    line: "blacklist usb-storage"
    create: yes
    state: present
  when: rhel8STIG_stigrule_230503_Manage and rhel8STIG_stigrule_230503_usb_storage_blacklist
  notify: do_reboot

# R-230504 RHEL-08-040090
- name: stigrule_230504_set_firewalld_default_zone
  ansible.builtin.command: "firewall-cmd --set-default-zone={{ rhel8STIG_stigrule_230504_firewalld_default_zone }}"
  when:
    - rhel8STIG_stigrule_230504_Manage
    - "'firewalld' in packages"

# R-230508 RHEL-08-040120
- name: stigrule_230508_mount_dev_shm_nodev
  ansible.posix.mount:
    path: /dev/shm
    src: tmpfs
    fstype: tmpfs
    opts: "{{ rhel8STIG_stigrule_230508_dev_shm_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230508_Manage

- name: stigrule_230508_configure_fstab_dev_shm
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^tmpfs\s+/dev/shm'
    line: 'tmpfs /dev/shm tmpfs {{ rhel8STIG_stigrule_230508_dev_shm_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230508_Manage

# R-230509 RHEL-08-040121
- name: stigrule_230509_mount_dev_shm_nosuid
  ansible.posix.mount:
    path: /dev/shm
    src: tmpfs
    fstype: tmpfs
    opts: "{{ rhel8STIG_stigrule_230509_dev_shm_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230509_Manage

- name: stigrule_230509_configure_fstab_dev_shm
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^tmpfs\s+/dev/shm'
    line: 'tmpfs /dev/shm tmpfs {{ rhel8STIG_stigrule_230509_dev_shm_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230509_Manage

# R-230510 RHEL-08-040122
- name: stigrule_230510_mount_dev_shm_noexec
  ansible.posix.mount:
    path: /dev/shm
    src: tmpfs
    fstype: tmpfs
    opts: "{{ rhel8STIG_stigrule_230510_dev_shm_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230510_Manage

- name: stigrule_230510_configure_fstab_dev_shm
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^tmpfs\s+/dev/shm'
    line: 'tmpfs /dev/shm tmpfs {{ rhel8STIG_stigrule_230510_dev_shm_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230510_Manage

# R-230511 RHEL-08-040123
- name: stigrule_230511_mount_tmp_nodev
  ansible.posix.mount:
    path: /tmp
    src: /dev/mapper/rhel-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230511_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230511_Manage

- name: stigrule_230511_configure_fstab_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-tmp\s+/tmp'
    line: '/dev/mapper/rhel-tmp /tmp xfs {{ rhel8STIG_stigrule_230511_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230511_Manage

# R-230512 RHEL-08-040124
- name: stigrule_230512_mount_tmp_nosuid
  ansible.posix.mount:
    path: /tmp
    src: /dev/mapper/rhel-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230512_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230512_Manage

- name: stigrule_230512_configure_fstab_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-tmp\s+/tmp'
    line: '/dev/mapper/rhel-tmp /tmp xfs {{ rhel8STIG_stigrule_230512_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230512_Manage

# R-230513 RHEL-08-040125
- name: stigrule_230513_mount_tmp_noexec
  ansible.posix.mount:
    path: /tmp
    src: /dev/mapper/rhel-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230513_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230513_Manage

- name: stigrule_230513_configure_fstab_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-tmp\s+/tmp'
    line: '/dev/mapper/rhel-tmp /tmp xfs {{ rhel8STIG_stigrule_230513_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230513_Manage

# R-230514 RHEL-08-040126
- name: stigrule_230514_mount_var_log_nodev
  ansible.posix.mount:
    path: /var/log
    src: /dev/mapper/rhel-var-log
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230514_var_log_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230514_Manage

- name: stigrule_230514_configure_fstab_var_log
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log\s+/var/log'
    line: '/dev/mapper/rhel-var-log /var/log xfs {{ rhel8STIG_stigrule_230514_var_log_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230514_Manage

# R-230515 RHEL-08-040127
- name: stigrule_230515_mount_var_log_nosuid
  ansible.posix.mount:
    path: /var/log
    src: /dev/mapper/rhel-var-log
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230515_var_log_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230515_Manage

- name: stigrule_230515_configure_fstab_var_log
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log\s+/var/log'
    line: '/dev/mapper/rhel-var-log /var/log xfs {{ rhel8STIG_stigrule_230515_var_log_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230515_Manage

# R-230516 RHEL-08-040128
- name: stigrule_230516_mount_var_log_noexec
  ansible.posix.mount:
    path: /var/log
    src: /dev/mapper/rhel-var-log
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230516_var_log_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230516_Manage

- name: stigrule_230516_configure_fstab_var_log
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log\s+/var/log'
    line: '/dev/mapper/rhel-var-log /var/log xfs {{ rhel8STIG_stigrule_230516_var_log_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230516_Manage

# R-230517 RHEL-08-040129
- name: stigrule_230517_mount_var_log_audit_nodev
  ansible.posix.mount:
    path: /var/log/audit
    src: /dev/mapper/rhel-var-log-audit
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230517_var_log_audit_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230517_Manage

- name: stigrule_230517_configure_fstab_var_log_audit
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log-audit\s+/var/log/audit'
    line: '/dev/mapper/rhel-var-log-audit /var/log/audit xfs {{ rhel8STIG_stigrule_230517_var_log_audit_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230517_Manage

# R-230518 RHEL-08-040130
- name: stigrule_230518_mount_var_log_audit_nosuid
  ansible.posix.mount:
    path: /var/log/audit
    src: /dev/mapper/rhel-var-log-audit
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230518_var_log_audit_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230518_Manage

- name: stigrule_230518_configure_fstab_var_log_audit
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log-audit\s+/var/log/audit'
    line: '/dev/mapper/rhel-var-log-audit /var/log/audit xfs {{ rhel8STIG_stigrule_230518_var_log_audit_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230518_Manage

# R-230519 RHEL-08-040131
- name: stigrule_230519_mount_var_log_audit_noexec
  ansible.posix.mount:
    path: /var/log/audit
    src: /dev/mapper/rhel-var-log-audit
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230519_var_log_audit_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230519_Manage

- name: stigrule_230519_configure_fstab_var_log_audit
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-log-audit\s+/var/log/audit'
    line: '/dev/mapper/rhel-var-log-audit /var/log/audit xfs {{ rhel8STIG_stigrule_230519_var_log_audit_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230519_Manage

# R-230520 RHEL-08-040132
- name: stigrule_230520_mount_var_tmp_nodev
  ansible.posix.mount:
    path: /var/tmp
    src: /dev/mapper/rhel-var-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230520_var_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230520_Manage

- name: stigrule_230520_configure_fstab_var_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-tmp\s+/var/tmp'
    line: '/dev/mapper/rhel-var-tmp /var/tmp xfs {{ rhel8STIG_stigrule_230520_var_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230520_Manage

# R-230521 RHEL-08-040133
- name: stigrule_230521_mount_var_tmp_nosuid
  ansible.posix.mount:
    path: /var/tmp
    src: /dev/mapper/rhel-var-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230521_var_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230521_Manage

- name: stigrule_230521_configure_fstab_var_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-tmp\s+/var/tmp'
    line: '/dev/mapper/rhel-var-tmp /var/tmp xfs {{ rhel8STIG_stigrule_230521_var_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230521_Manage

# R-230522 RHEL-08-040134
- name: stigrule_230522_mount_var_tmp_noexec
  ansible.posix.mount:
    path: /var/tmp
    src: /dev/mapper/rhel-var-tmp
    fstype: xfs
    opts: "{{ rhel8STIG_stigrule_230522_var_tmp_mount_options }}"
    state: mounted
  when: rhel8STIG_stigrule_230522_Manage

- name: stigrule_230522_configure_fstab_var_tmp
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^/dev/mapper/rhel-var-tmp\s+/var/tmp'
    line: '/dev/mapper/rhel-var-tmp /var/tmp xfs {{ rhel8STIG_stigrule_230522_var_tmp_mount_options }} 0 0'
    state: present
  when: rhel8STIG_stigrule_230522_Manage

# R-230523 RHEL-08-040135
- name: stigrule_230523_install_fapolicyd
  ansible.builtin.yum:
    name: fapolicyd
    state: "{{ rhel8STIG_stigrule_230523_fapolicyd_State }}"
  when: rhel8STIG_stigrule_230523_Manage

# R-230524 RHEL-08-040140
- name: Ensure /etc/usbguard directory exists
  ansible.builtin.file:
    path: /etc/usbguard
    state: directory
    mode: '0755'
  when: rhel8STIG_stigrule_230524_Manage 

- name: Create empty /etc/usbguard/rules.conf file (if it doesn't exist)
  ansible.builtin.copy:
    dest: /etc/usbguard/rules.conf
    content: |
      # USBGuard policy rules
      # This file is managed by Ansible.
      # Policy is intentionally minimal or empty on this system type.
    owner: root
    group: root
    mode: '0600'
  when:
    - rhel8STIG_stigrule_230524_Manage 

- name: stigrule_230524_generate_usbguard_policy
  ansible.builtin.command: "{{ rhel8STIG_stigrule_230524_usbguard_policy_Command }}"
  args:
    creates: /etc/usbguard/rules.conf
  when: rhel8STIG_stigrule_230524_Manage

# R-230532 RHEL-08-040180
- name: stigrule_230532_mask_debug_shell_service
  ansible.builtin.systemd:
    name: debug-shell.service
    masked: "{{ rhel8STIG_stigrule_230532_debug_shell_Masked }}"
    state: stopped
  when: rhel8STIG_stigrule_230532_Manage
  notify: daemon_reload

# R-230546 RHEL-08-040282
- name: stigrule_230546__etc_sysctl_d_99_sysctl_conf
  lineinfile:
    path: /etc/sysctl.d/99-sysctl.conf
    regexp: '^kernel.yama.ptrace_scope = '
    line: "{{ rhel8STIG_stigrule_230546__etc_sysctl_d_99_sysctl_conf_Line }}"
    create: yes
  when:
    - rhel8STIG_stigrule_230546_Manage

- name: stigrule_230546_kernel_yama_ptrace_scope
  sysctl:
    name: kernel.yama.ptrace_scope
    value: "{{ rhel8STIG_stigrule_230546_kernel_yama_ptrace_scope_Value }}"
  when:
    - rhel8STIG_stigrule_230546_Manage

# R-237642 RHEL-08-010383
- name: stigrule_237642_sudo_disable_targetpw
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+!targetpw'
    line: "{{ rhel8STIG_stigrule_237642_sudo_targetpw_Line }}"
    state: present
    validate: 'visudo -cf %s'
  when: rhel8STIG_stigrule_237642_Manage

- name: stigrule_237642_sudo_disable_rootpw
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+!rootpw'
    line: "{{ rhel8STIG_stigrule_230296_PermitRootLogin_Line }}"
    state: present
    validate: 'visudo -cf %s'
  when: rhel8STIG_stigrule_237642_Manage

- name: stigrule_237642_sudo_disable_runaspw
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+!runaspw'
    line: "{{ rhel8STIG_stigrule_237642_sudo_runaspw_Line }}"
    state: present
    validate: 'visudo -cf %s'
  when: rhel8STIG_stigrule_237642_Manage

# R-237643 RHEL-08-010384
- name: stigrule_237643_sudo_require_reauthentication
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+timestamp_timeout='
    line: "Defaults timestamp_timeout={{ rhel8STIG_stigrule_237643_sudo_timestamp_timeout_Value }}"
    state: present
    validate: 'visudo -cf %s'
  when: rhel8STIG_stigrule_237643_Manage

# R-244530 RHEL-08-010572
- name: stigrule_244530_mount_boot_efi_nosuid
  ansible.posix.mount:
    path: /boot/efi
    src: /dev/sda1 # Adjust if your /boot/efi is on a different device
    fstype: vfat
    opts: "rw,{{ rhel8STIG_stigrule_244530_boot_efi_nosuid_MountOption }},relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=winnt,errors=remount-ro"
    state: mounted
  when:
    - rhel8STIG_stigrule_244530_Manage
    - ansible_facts.os_family == "RedHat" # Assuming this is for RHEL 8 specifically
    - ansible_facts.mounts | selectattr('mount', '==', '/boot/efi') | list | length > 0
    - "'nosuid' not in (ansible_facts.mounts | selectattr('mount', '==', '/boot/efi') | map(attribute='options') | first)"

# R-244531 RHEL-08-010731
- name: stigrule_244531_set_home_directory_file_mode
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "{{ rhel8STIG_stigrule_244531_home_dir_file_mode }}"
    recurse: yes
  loop: "{{ ansible_facts.users | selectattr('home', 'defined') | selectattr('uid', '>=', 1000) | map(attribute='home') | list }}"
  when: rhel8STIG_stigrule_244531_Manage

# R-244533 RHEL-08-020025
- name: stigrule_244533_configure_pam_faillock_system_auth_preauth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^\s*auth\s+required\s+pam_unix.so'
    line: "auth required pam_faillock.so preauth\nauth sufficient pam_unix.so"
    insertbefore: "pam_unix.so"
    state: present
  when: rhel8STIG_stigrule_244533_Manage

- name: stigrule_244533_configure_pam_faillock_system_auth_authfail
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^\s*auth\s+sufficient\s+pam_unix.so'
    line: "auth required pam_faillock.so authfail"
    insertafter: '^\s*auth\s+sufficient\s+pam_unix.so'
    state: present
  when: rhel8STIG_stigrule_244533_Manage

- name: stigrule_244533_configure_pam_faillock_system_auth_account
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^\s*account\s+required\s+pam_unix.so'
    line: "account required pam_faillock.so"
    insertbefore: '^\s*account\s+required\s+pam_unix.so'
    state: present
  when: rhel8STIG_stigrule_244533_Manage

# R-244534 RHEL-08-020026
- name: stigrule_244534_configure_pam_faillock_password_auth_preauth
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    regexp: '^\s*auth\s+required\s+pam_unix.so'
    line: "auth required pam_faillock.so preauth\nauth sufficient pam_unix.so"
    insertbefore: "pam_unix.so"
    state: present
  when: rhel8STIG_stigrule_244534_Manage

- name: stigrule_244534_configure_pam_faillock_password_auth_authfail
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    regexp: '^\s*auth\s+sufficient\s+pam_unix.so'
    line: "auth required pam_faillock.so authfail"
    insertafter: '^\s*auth\s+sufficient\s+pam_unix.so'
    state: present
  when: rhel8STIG_stigrule_244534_Manage

- name: stigrule_244534_configure_pam_faillock_password_auth_account
  ansible.builtin.lineinfile:
    path: /etc/pam.d/password-auth
    regexp: '^\s*account\s+required\s+pam_unix.so'
    line: "account required pam_faillock.so"
    insertbefore: '^\s*account\s+required\s+pam_unix.so'
    state: present
  when: rhel8STIG_stigrule_244534_Manage

# R-244536 RHEL-08-020032
- name: stigrule_244536__etc_dconf_db_local_d_02_login_screen
  ini_file:
    path: /etc/dconf/db/local.d/02-login-screen
    section: org/gnome/login-screen
    option: disable-user-list
    value: "{{ rhel8STIG_stigrule_244536__etc_dconf_db_local_d_02_login_screen_Value }}"
    no_extra_spaces: yes
  notify: dconf_update
  when:
    - rhel8STIG_stigrule_244536_Manage
    - "'dconf' in packages"

# R-244545 RHEL-08-040136
- name: stigrule_244545_enable_fapolicyd
  ansible.builtin.systemd:
    name: fapolicyd
    enabled: "{{ rhel8STIG_stigrule_244545_fapolicyd_Enabled }}"
    state: started
  when: rhel8STIG_stigrule_244545_Manage

# R-244546 RHEL-08-040137
- name: stigrule_244546_set_fapolicyd_permissive_mode
  ansible.builtin.lineinfile:
    path: /etc/fapolicyd/fapolicyd.conf
    regexp: '^permissive\s*='
    line: "permissive = {{ rhel8STIG_stigrule_244546_fapolicyd_permissive_Mode }}"
    state: present
  when: rhel8STIG_stigrule_244546_Manage

- name: stigrule_244546_add_fapolicyd_deny_all_rule_old
  ansible.builtin.lineinfile:
    path: /etc/fapolicyd/fapolicyd.rules
    line: "{{ rhel8STIG_stigrule_244546_fapolicyd_deny_all_Rule }}"
    insertafter: EOF
    state: present
  when:
    - rhel8STIG_stigrule_244546_Manage
    - ansible_facts.distribution_major_version | int <= 8 and ansible_facts.distribution_version.split('.')[1] | int <= 4

- name: stigrule_244546_add_fapolicyd_deny_all_rule_new
  ansible.builtin.lineinfile:
    path: /etc/fapolicyd/rules.d/99-deny-all.rules
    line: "{{ rhel8STIG_stigrule_244546_fapolicyd_deny_all_Rule }}"
    create: yes
    state: present
  when:
    - rhel8STIG_stigrule_244546_Manage
    - ansible_facts.distribution_major_version | int == 8 and ansible_facts.distribution_version.split('.')[1] | int >= 5

# R-244547 RHEL-08-040139
- name: stigrule_244547_install_usbguard
  ansible.builtin.yum:
    name: usbguard
    state: "{{ rhel8STIG_stigrule_244547_usbguard_State }}"
  when: rhel8STIG_stigrule_244547_Manage

# R-244548 RHEL-08-040141
- name: stigrule_244548_enable_usbguard
  ansible.builtin.systemd:
    name: usbguard
    enabled: "{{ rhel8STIG_stigrule_244548_usbguard_Enabled }}"
    state: started
  when: rhel8STIG_stigrule_244548_Manage


# R-250317 RHEL-08-010359
- name: stigrule_250317_install_aide
  ansible.builtin.yum:
    name: aide
    state: "{{ rhel8STIG_stigrule_250317_aide_State }}"
  when: rhel8STIG_stigrule_250317_Manage

- name: stigrule_250317_initialize_aide_if_needed
  ansible.builtin.command: "/usr/sbin/aide --init"
  args:
    creates: /var/lib/aide/aide.db.new.gz # This ensures it only runs if .new.gz does not exist
  when: rhel8STIG_stigrule_250317_Manage

- name: stigrule_250317_move_aide_db
  ansible.builtin.command: "mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz"
  args:
    removes: /var/lib/aide/aide.db.new.gz # This ensures it only runs if .new.gz exists
  when: rhel8STIG_stigrule_250317_Manage


# R-251716 RHEL-08-020104
- name: stigrule_251716_configure_pwquality_retry
  ansible.builtin.lineinfile:
    path: /etc/security/pwquality.conf
    regexp: '^\s*retry\s*='
    line: "retry = {{ rhel8STIG_stigrule_251716_pwquality_retry_Value }}"
    state: present
    create: yes
  when: rhel8STIG_stigrule_251716_Manage

# R-251718 RHEL-08-040321
- name: stigrule_251718_set_default_target
  ansible.builtin.command: "systemctl set-default {{ rhel8STIG_stigrule_251718_default_target }}"
  args:
    creates: /etc/systemd/system/default.target # The simplest idempotency check
  when: rhel8STIG_stigrule_251718_Manage
  notify: do_reboot

# R-257258 RHEL-08-020035
- name: stigrule_257258_terminate_idle_sessions
  ansible.builtin.lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?StopIdleSessionSec='
    line: "StopIdleSessionSec={{ rhel8STIG_stigrule_257258_StopIdleSessionSec_Value }}"
    state: present
  when: rhel8STIG_stigrule_257258_Manage
  notify: systemd_logind_restart

# R-272482 RHEL-08-010296
- name: stigrule_272482_configure_ssh_client_macs
  ansible.builtin.lineinfile:
    path: "{{ ansible_real_path }}/openssh.config" # Corrected: Removed ansible_facts.
    regexp: '^(-oMACs=.*)$'
    line: "{{ rhel8STIG_stigrule_272482_openssh_client_MACs_Line }}"
    state: present
  vars:
    ansible_real_path: "{{ '/etc/crypto-policies/back-ends' }}" # This variable is correct
  when: rhel8STIG_stigrule_272482_Manage
  notify:
    - do_reboot

# R-272483 RHEL-08-010297
- name: stigrule_272483_get_openssh_config_realpath
  ansible.builtin.stat:
    path: /etc/crypto-policies/back-ends/openssh.config
  register: openssh_config_path_stat
  when: rhel8STIG_stigrule_272483_Manage

- name: stigrule_272483_configure_ssh_client_ciphers
  ansible.builtin.lineinfile:
    # Use the realpath if it exists and is a symlink, otherwise use the original path.
    # The default filter handles cases where 'realpath' is not defined.
    path: "{{ openssh_config_path_stat.stat.realpath | default('/etc/crypto-policies/back-ends/openssh.config') }}"
    regexp: '^(-oCiphers=.*)$'
    line: "{{ rhel8STIG_stigrule_272483_openssh_client_Ciphers_Line }}"
    state: present
  when: rhel8STIG_stigrule_272483_Manage and openssh_config_path_stat.stat.exists
  notify:
    - do_reboot

# R-272484 RHEL-08-010455
- name: stigrule_272484_elevate_selinux_context_sudo
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/00-selinux-sudo
    line: "{{ rhel8STIG_stigrule_272484_sudo_selinux_context }}"
    create: yes
    state: present
    validate: 'visudo -cf %s'
  when: rhel8STIG_stigrule_272484_Manage

