- name: Identify reachable hosts
  hosts: all
  become: true  
  gather_facts: false
  strategy: linear
  vars_files:
    - ../../vaults/vault_vm.yml
  vars:
    ansible_become_password: "{{ remote_host_become_pass }}" 
    ansible_remote_tmp: /var/ansible_tmp

  tasks:
    - block:
        - name: Quick check for SSH connection readiness
          ansible.builtin.wait_for_connection:
            timeout: 5 # Fail fast if no SSH connection
          delegate_to: "{{ inventory_hostname }}" # Ensure this runs against the target host

        - name: Add device to general 'reachable' group
          ansible.builtin.group_by:
            key: "reachable"
            # No need for ansible_hostname here for the general group, it's just 'reachable'

      rescue:
        - name: Mark unreachable host
          ansible.builtin.debug:
            msg: "Host {{ inventory_hostname }} is unreachable within the initial check. Skipping."
          # No need to create a group for unreachable. The absence from 'reachable' implies unreachability.

- name: Initiate Reboot via Shell and Poll for System Readiness
  # This part now runs *only* on hosts already identified as 'reachable'
  hosts: reachable # Target only the hosts confirmed reachable
  gather_facts: false
  become: true
  vars_files:
    - ../../vaults/vault_vm.yml
  vars:
    ansible_become_password: "{{ remote_host_become_pass }}" 
    ansible_remote_tmp: /var/ansible_tmp

  tasks:
    - name: Initiate system reboot via shell
      ansible.builtin.shell: |
        shutdown -r now "Ansible initiated controlled reboot"
      async: 10
      poll: 0
      ignore_errors: true 

    - name: Poll until system is reachable after reboot
      ansible.builtin.wait_for_connection:
        timeout: 450
        delay: 15
      register: system_reconnect_status

    - name: Verify system is up and reachable
      ansible.builtin.ping:
      register: ping_result

    - name: Report final status
      ansible.builtin.debug:
        msg: "System {{ inventory_hostname }} is {{ 'up and reachable' if ping_result.ping == 'pong' else 'down or unreachable' }} after shell-initiated reboot."