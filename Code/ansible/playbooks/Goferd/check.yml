---
- name: Determine if goferd service is running and associated packages are installed
  hosts: all
  become: yes
  gather_facts: true
  vars_files:
    - ../../vaults/vbox_vault.yml
  vars:
    ansible_become_password: "{{ remote_host_become_pass }}" 
    ansible_remote_tmp: /var/ansible_tmp
    # Common package names that provide the goferd agent/service on RHEL/CentOS
    goferd_packages:
      - katello-agent
      - python-gofer
      - gofer  # In case a distribution packages it directly

  tasks:
    - name: Ensure target is a Red Hat based system (where goferd is common)
      ansible.builtin.fail:
        msg: "This playbook is designed for Red Hat / CentOS / Fedora systems."
      when: ansible_facts['os_family'] != "RedHat"

    # Gather all service facts to check status
    - name: Gather service facts
      ansible.builtin.service_facts:

    # Gather package facts to check installation
    - name: Gather package facts
      ansible.builtin.package_facts:

    - name: Set fact for service status
      ansible.builtin.set_fact:
        goferd_installed: "{{ 'goferd.service' in ansible_facts.services }}"
        goferd_state: "{{ ansible_facts.services['goferd.service'].state | default('not loaded') }}"
        goferd_running: "{{ ('goferd.service' in ansible_facts.services) and (ansible_facts.services['goferd.service'].state == 'running') }}"

    # Check if any associated packages are installed
    - name: Set fact for installed packages
      ansible.builtin.set_fact:
        installed_goferd_packages: "{{ goferd_packages | select('in', ansible_facts.packages) | list }}"
        any_goferd_package_installed: "{{ goferd_packages | select('in', ansible_facts.packages) | length > 0 }}"

    - name: Display service status and package information
      ansible.builtin.debug:
        msg: |
          Goferd Service Status:
          - Service Unit Loaded: {{ goferd_installed }}
          - Current State: {{ goferd_state }}
          - Is Running: {{ goferd_running }}

          Installed Goferd-Related Packages:
          - Packages Found: {{ installed_goferd_packages | join(', ') if installed_goferd_packages else 'None' }}

    # Optional: If service not detected, check if it's managed differently (e.g., via pid or process)
    - name: Check if goferd process is running (as fallback)
      ansible.builtin.command: pgrep -x goferd
      register: goferd_process
      ignore_errors: true
      when: not goferd_running
      changed_when: false

    - name: Display process check result if done
      ansible.builtin.debug:
        msg: "Goferd process detected (PID: {{ goferd_process.stdout }})"
      when: 
        - not goferd_running
        - goferd_process.stdout is defined and goferd_process.stdout != ""

    - name: Fail if neither service nor process is found and no packages installed
      ansible.builtin.fail:
        msg: "Goferd is not found: Service not running, process not detected, and no associated packages installed."
      when: 
        - not any_goferd_package_installed
        - not goferd_running
        - goferd_process is failed or goferd_process.stdout is undefined or goferd_process.stdout == ""
