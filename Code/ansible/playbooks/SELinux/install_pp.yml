---
- name: Install Dynatrace SELinux Policies
  hosts: all
  become: true
  vars_files:
    - ../../vaults/vbox_vault.yml
  vars:
    ansible_remote_tmp: /var/ansible_tmp
    selinux_policy_dir: "/opt/dynatrace/oneagent/agent/SELinuxPolicy"

  tasks:
    - name: Find and install all .pp files from Dynatrace
      shell: |
        for policy in {{ selinux_policy_dir }}/*.pp; do
          if [ -f "$policy" ]; then
            policy_name=$(basename "$policy" .pp)
            if ! semodule -l | grep -q "^${policy_name} "; then
              echo "Installing $policy"
              semodule -i "$policy"
            else
              echo "Policy $policy_name already installed"
            fi
          fi
        done
      args:
        warn: false
      register: install_result

    - name: Display installation results
      debug:
        msg: "{{ install_result.stdout }}"